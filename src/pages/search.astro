---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Search" description="Search for posts on the Chinese SDG Institute website.">
  <div class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8 text-center">Search</h1>
    <div class="max-w-2xl mx-auto">
      <div class="relative">
        <input id="search-input" type="text" placeholder="Search for articles..." class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="search-button" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
      </div>
    </div>
    <div id="search-results" class="mt-8 max-w-3xl mx-auto">
      <!-- Search results will be displayed here -->
    </div>
  </div>
</MainLayout>

<script>
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const searchResultsContainer = document.getElementById('search-results');

  function performSearch() {
    const query = searchInput.value;
    if (query) {
      window.location.href = `/search?q=${encodeURIComponent(query)}`;
    }
  }

  searchButton.addEventListener('click', performSearch);
  searchInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      performSearch();
    }
  });

  function highlightText(text, query) {
    if (!text) return '';
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
  }

  function getSnippet(text, query) {
    if (!text) return '';
    // This is a simplified snippet generation.
    // A more advanced implementation would be needed for better results.
    const textAsString = text.map(block => block.children.map(child => child.text).join('')).join('\n');
    const index = textAsString.toLowerCase().indexOf(query.toLowerCase());
    if (index === -1) {
      return highlightText(textAsString.substring(0, 200) + '...', query);
    }
    const start = Math.max(0, index - 100);
    const end = Math.min(textAsString.length, index + 100);
    return '...' + highlightText(textAsString.substring(start, end), query) + '...';
  }

  async function fetchAndDisplayResults(query) {
    searchResultsContainer.innerHTML = `<p class="text-center">Searching for "${query}"...</p>`;
    try {
      const response = await fetch(`/api/search-posts.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ q: query }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('API Error:', errorData);
        throw new Error('Search failed');
      }
      const results = await response.json();

      if (results.length === 0) {
        searchResultsContainer.innerHTML = '<p class="text-center">No results found.</p>';
        return;
      }

      const html = results.map(post => {
        const snippet = getSnippet(post.body, query);
        return `
          <div class="mb-8">
            <a href="/post/${post.slug}" class="text-2xl font-bold hover:underline">${highlightText(post.title, query)}</a>
            <p class="text-gray-600 mt-2">${snippet}</p>
          </div>
        `;
      }).join('');

      searchResultsContainer.innerHTML = html;
    } catch (error) {
      searchResultsContainer.innerHTML = `<p class="text-center text-red-500">Error: Could not fetch search results.</p>`;
      console.error(error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
      searchInput.value = query;
      fetchAndDisplayResults(query);
    }
  });
</script>
