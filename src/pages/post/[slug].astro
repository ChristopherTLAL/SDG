---
import MainLayout from '../../layouts/MainLayout.astro';
import { ContentView } from '../../components/ContentView.tsx';
import { getAllPostSlugs, getPostBySlug } from '../../lib/sanity/queries';
import { urlForImage } from '../../lib/sanity/image';
import { formatDate } from '../../utils/date';

export async function getStaticPaths() {
  const slugs = await getAllPostSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug!);
---

<MainLayout title={post?.title ?? 'Post'} description={post?.excerpt}>
  {post ? (
    <article class="max-w-2xl mx-auto">
      <header class="mb-8">
        {post.category && <p class="text-sm font-semibold tracking-wider uppercase text-gray-500">{post.category}</p>}
        <h1 class="text-4xl font-bold leading-tight text-white xl:text-black mt-2 font-serif">{post.title}</h1>
        {post.excerpt && <p class="mt-4 text-lg text-gray-400 xl:text-gray-600">{post.excerpt}</p>}
        <div class="flex items-center mt-6">
          {post.author?.avatar && (
            <img
              class="w-12 h-12 mr-4 rounded-full"
              src={post.author.avatar}
              alt={post.author.name}
            />
          )}
          <div>
            <p class="text-lg font-semibold text-white xl:text-black">{post.author?.name}</p>
            <p class="text-sm text-gray-500">{formatDate(post.publishedAt)}</p>
          </div>
        </div>
      </header>

      {post.mainImage && (
        <img
          class="object-cover w-full h-auto mb-8 rounded-lg"
          src={urlForImage(post.mainImage).width(1200).url()}
          alt={post.title}
        />
      )}

      <div class="article-body">
        <ContentView client:load value={post.body} />
      </div>
    </article>
  ) : (
    <p>未找到该文章。</p>
  )}
</MainLayout>
