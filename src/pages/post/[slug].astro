---
import MainLayout from '../../layouts/MainLayout.astro';
import { ContentView } from '../../components/ContentView.tsx';
import { getAllPostSlugs, getPostBySlug } from '../../lib/sanity/queries';
import { urlForImage } from '../../lib/sanity/image';
import { formatDate } from '../../utils/date';

export async function getStaticPaths() {
  const slugs = await getAllPostSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug!);
---

<MainLayout title={post?.title ?? 'Post'} description={post?.excerpt}>
  {post ? (
    <article class="max-w-4xl mx-auto">
      {post.mainImage && (
        <div class="mb-8 rounded-lg overflow-hidden aspect-w-21 aspect-h-9">
          <img
            class="w-full h-full object-cover"
            src={urlForImage(post.mainImage).width(1200).height(514).url()}
            alt={post.title}
          />
        </div>
      )}
      <header class="mb-8">
        <h1 class="text-4xl font-bold leading-tight text-black dark:text-white mt-2 font-serif mb-4">{post.title}</h1>
        
        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-4">
          {post.category && (
            <p class="font-semibold tracking-wider uppercase mr-4">{post.category}</p>
          )}
          <div class="flex items-center">
            {post.author?.avatar && (
              <img
                class="w-8 h-8 mr-2 rounded-full"
                src={post.author.avatar}
                alt={post.author.name}
              />
            )}
            <p class="font-semibold">{post.author?.name}</p>
            <span class="mx-2">|</span>
            <p>{formatDate(post.publishedAt)}</p>
          </div>
        </div>

        {post.excerpt && <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">{post.excerpt}</p>}
      </header>

      <div class="article-body">
        <ContentView client:load value={post.body} />
      </div>
    </article>
  ) : (
    <p>未找到该文章。</p>
  )}
</MainLayout>
