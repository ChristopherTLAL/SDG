---
// --- 1. 数据获取 ---
// 导入你的 Sanity 客户端和图片 URL 构建器
// (请确保路径 '../lib/sanity' 是正确的)
import { sanityClient, urlFor } from '../lib/sanity';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

// 导入主模板
import MainLayout from '../layouts/MainLayout.astro';

// 定义文章的数据结构 (TypeScript 类型)
interface Post {
  _id: string;
  title: string;
  slug: {
    current: string;
  };
  publishDate: string;
  coverImage?: SanityImageSource;
  excerpt?: string;
}

// GROQ 查询：获取所有类型为 'post' 的文档，按发布日期倒序排列
const query = `*[_type == "post"] | order(publishDate desc)`;

// 从 Sanity 获取所有文章数据
const allPosts: Post[] = await sanityClient.fetch(query);

// --- 2. 拆分数据用于布局 ---
// 将第一篇文章作为 "头条"
const featuredPost = allPosts[0];
// 将剩余的文章作为 "最新列表"
const latestPosts = allPosts.slice(1);

// 辅助函数：简单格式化日期 (例如 2025-10-31)
function formatDate(dateString: string) {
  try {
    const date = new Date(dateString);
    // 增加一天，修复可能的时区问题 (Sanity 日期可能被解释为 UTC 午夜)
    date.setUTCDate(date.getUTCDate() + 1);
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch (e) {
    return dateString; // 出错时返回原始字符串
  }
}
---

<MainLayout>
  <div classT="container mx-auto px-6 py-12 md:py-16">
    
    <!-- === 头条文章 (Featured Post) === -->
    {featuredPost && (
      <section id="featured-story" class="mb-12 md:mb-16">
        <a href={`/post/${featuredPost.slug.current}`} class="group block overflow-hidden rounded-2xl bg-white dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/50 shadow-lg hover:shadow-2xl transition-all duration-300">
          <div class="md:flex">
            <!-- 头条-图片 -->
            {featuredPost.coverImage && (
              <div class="md:w-3/5 overflow-hidden">
                <img
                  src={urlFor(featuredPost.coverImage).width(1200).height(800).auto('format').url()}
                  alt={`[${featuredPost.title} 的封面图片]`}
                  class="w-full h-64 md:h-full object-cover object-center group-hover:scale-105 transition-transform duration-500 ease-in-out"
                />
              </div>
            )}
            <!-- 头条-文字 -->
            <div class="md:w-2/5 p-6 md:p-10 flex flex-col justify-center">
              <span class="text-sm font-semibold text-blue-600 dark:text-blue-400 uppercase tracking-wider">
                头条
              </span>
              <h2 class="text-2xl md:text-4xl font-bold text-gray-900 dark:text-white mt-3 mb-4 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                {featuredPost.title}
              </h2>
              <p class="text-gray-600 dark:text-gray-400 text-base md:text-lg mb-5">
                {featuredPost.excerpt || '暂无摘要'}
              </p>
              <span class="text-sm text-gray-500 dark:text-gray-500">
                {formatDate(featuredPost.publishDate)}
              </span>
            </div>
          </div>
        </a>
      </section>
    )}

    <!-- === 主要内容区域 (最新文章 + SDG 侧边栏) === -->
    <section id="content-grid" class="lg:grid lg:grid-cols-12 lg:gap-12">
      
      <!-- 最新文章列表 (Main Feed) -->
      <div class="lg:col-span-8">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8 border-b border-gray-200 dark:border-gray-700 pb-4">
          最新动态
        </h2>
        
        <div class="space-y-10">
          {latestPosts.length > 0 ? (
            latestPosts.map(post => (
              <a href={`/post/${post.slug.current}`} class="group grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
                <!-- 文章卡片-图片 -->
                <div class="md:col-span-1 overflow-hidden rounded-lg">
                  {post.coverImage ? (
                    <img
                      src={urlFor(post.coverImage).width(400).height(300).auto('format').url()}
                      alt={`[${post.title} 的封面图片]`}
                      class="w-full h-auto object-cover object-center group-hover:opacity-80 transition-opacity duration-300"
                    />
                  ) : (
                    <div class="w-full h-32 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-500">
                      无图片
                    </div>
                  )}
                </div>
                <!-- 文章卡片-文字 -->
                <div class="md:col-span-3">
                  <h3 class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                    {post.title}
                  </h3>
                  <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base mb-3 hidden md:block">
                    {post.excerpt || '暂无摘要'}
                  </p>
                  <span class="text-sm text-gray-500 dark:text-gray-500">
                    {formatDate(post.publishDate)}
                  </span>
                </div>
              </a>
            ))
          ) : (
            <p class="text-gray-500 dark:text-gray-400">暂无文章。</p>
          )}
        </div>
      </div>

      <!-- 侧边栏 (Sidebar) -->
      <aside class="lg:col-span-4 mt-12 lg:mt-0">
        <!-- 你原来的 SDG 板块被移到这里，作为侧边栏 -->
        <section id="sdgs" class="sticky top-24 p-6 bg-gray-100 dark:bg-black/20 rounded-2xl">
          <div class="text-left mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">聚焦 SDG 目标</h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">探索与联合国可持续发展目标相关的议题。</p>
          </div>
          <div id="sdg-grid" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-3 gap-3">
            <!-- SDG Cards will be injected here by JS (和你原来一样) -->
          </div>
        </section>
      </aside>

    </section>

  </div>
</MainLayout>
