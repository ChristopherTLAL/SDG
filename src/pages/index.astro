---
// --- 1. 数据获取 ---
import { sanityClient } from '../lib/sanity';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';
import MainLayout from '../layouts/MainLayout.astro'; // 导入主模板

// --- 1b. 设置图像 URL 构建器 ---
const builder = imageUrlBuilder(sanityClient);
function urlFor(source: SanityImageSource) {
  return builder.image(source);
}

// --- 1c. 定义数据结构 (已更新) ---
interface Post {
  _id: string;
  title: string;
  slug: {
    current: string;
  };
  publishDate: string;
  coverImage?: SanityImageSource;
  excerpt?: string;
  sdgs?: string[]; // <--- 新增：用于按 SDG 分类
}

// --- 1d. GROQ 查询 (已更新) ---
// 获取所有文章，并带上 sdgs 字段，按日期倒序
const query = `*[_type == "post"] {
  _id,
  title,
  slug,
  publishDate,
  coverImage,
  excerpt,
  sdgs
} | order(publishDate desc)`;

const allPosts: Post[] = await sanityClient.fetch(query);

// --- 2. 拆分数据用于布局 ---
const featuredPost = allPosts[0];         // 第 1 篇 = 英雄头条
const topStoryPosts = allPosts.slice(1, 6); // 第 2-6 篇 = 最新动态
const otherPosts = allPosts.slice(6);       // 剩余文章 = 用于 SDG 分类筛选

// --- 3. SDG 分类数据 ---
// 这是一个例子，你可以复制这个逻辑来创建所有 SDG 板块
// 从 "otherPosts" 中筛选，避免和头条、最新动态重复
const sdg1Posts = otherPosts.filter(p => p.sdgs?.includes('1')).slice(0, 4);
const sdg2Posts = otherPosts.filter(p => p.sdgs?.includes('2')).slice(0, 4);
// ... 在下面 HTML 中为其他 SDG 重复此模式

// 辅助函数：格式化日期
function formatDate(dateString: string) {
  try {
    const date = new Date(dateString);
    date.setUTCDate(date.getUTCDate() + 1);
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  } catch (e) {
    return dateString;
  }
}

// 辅助函数：获取 SDG 标题 (你需要补充完整)
function getSdgTitle(sdgValue: string) {
  const titles: { [key: string]: string } = {
    '1': 'SDG 1: 无贫穷',
    '2': 'SDG 2: 零饥饿',
    '3': 'SDG 3: 良好健康与福祉',
    '4': 'SDG 4: 优质教育',
    // ... 在这里添加所有17个目标的标题
  };
  return titles[sdgValue] || 'SDG 目标';
}
---

<MainLayout>
  <!-- 
    这个 div 是我们页面的主容器。
    我们不再使用 Tailwind，而是用自定义的 CSS 类。
  -->
  <div class="page-container">
    
    <!-- === 1. 头条文章 (Hero Article) === -->
    {featuredPost && (
      <section class="hero-article-wrapper">
        <a href={`/post/${featuredPost.slug.current}`} class="hero-article">
          {featuredPost.coverImage && (
            <img
              class="hero-article__image"
              src={urlFor(featuredPost.coverImage).width(1600).height(900).auto('format').url()}
              alt={`[${featuredPost.title} 的封面图片]`}
              fetchpriority="high"
            />
          )}
          <div class="hero-article__gradient"></div>
          <div class="hero-article__content">
            <h1 class="hero-article__heading">
              {featuredPost.title}
            </h1>
            <div class="hero-article__byline">
              {formatDate(featuredPost.publishDate)}
            </div>
          </div>
        </a>
      </section>
    )}

    <!-- === 2. 最新动态 (Top Stories) === -->
    {topStoryPosts.length > 0 && (
      <section id="top-stories" class="top-stories">
        <h2 class="section-heading">最新动态</h2>
        <div class="top-stories__grid">
          <!-- 大卡片 (左侧) -->
          <div class="top-stories__left">
            {topStoryPosts[0] && (
              <article class="content-card content-card--large">
                <a href={`/post/${topStoryPosts[0].slug.current}`} class="content-card__link">
                  {topStoryPosts[0].coverImage ? (
                    <div class="content-card__image-container">
                      <img
                        class="content-card__image"
                        src={urlFor(topStoryPosts[0].coverImage).width(800).height(500).auto('format').url()}
                        alt={`[${topStoryPosts[0].title} 的封面图片]`}
                        loading="lazy"
                      />
                    </div>
                  ) : (
                    <div class="content-card__image-placeholder"></div>
                  )}
                  <div class="content-card__content">
                    <h3 class="content-card__title">{topStoryPosts[0].title}</h3>
                    <p class="content-card__excerpt">{topStoryPosts[0].excerpt}</p>
                    <span class="content-card__meta">{formatDate(topStoryPosts[0].publishDate)}</span>
                  </div>
                </a>
              </article>
            )}
          </div>
          <!-- 小卡片 (右侧) -->
          <div class="top-stories__right">
            {topStoryPosts.slice(1).map(post => (
              <article class="content-card content-card--small">
                <a href={`/post/${post.slug.current}`} class="content-card__link">
                  {post.coverImage ? (
                    <div class="content-card__image-container">
                      <img
                        class="content-card__image"
                        src={urlFor(post.coverImage).width(400).height(300).auto('format').url()}
                        alt={`[${post.title} 的封面图片]`}
                        loading="lazy"
                      />
                    </div>
                  ) : (
                    <div class="content-card__image-placeholder--small"></div>
                  )}
                  <div class="content-card__content">
                    <h3 class="content-card__title">{post.title}</h3>
                    <span class="content-card__meta">{formatDate(post.publishDate)}</span>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- === 3. SDG 分类板块 (示例 1) === -->
    <!-- 我给这个 section 添加了 ID，以便导航栏链接能跳转 -->
    {sdg1Posts.length > 0 && (
      <section id="sdg-sections" class="category-showcase">
        <h2 class="section-heading">
          <a href="/sdg/1">{getSdgTitle('1')}</a>
        </h2>
        <div class="category-showcase__grid">
          {sdg1Posts.map(post => (
            <article class="content-card content-card--small">
              <a href={`/post/${post.slug.current}`} class="content-card__link">
                {post.coverImage ? (
                  <div class="content-card__image-container">
                    <img
                      class="content-card__image"
                      src={urlFor(post.coverImage).width(400).height(300).auto('format').url()}
                      alt={`[${post.title} 的封面图片]`}
                      loading="lazy"
                    />
                  </div>
                ) : (
                  <div class="content-card__image-placeholder--small"></div>
                )}
                <div class="content-card__content">
                  <h3 class="content-card__title">{post.title}</h3>
                  <span class="content-card__meta">{formatDate(post.publishDate)}</span>
                </div>
              </a>
            </article>
          ))}
        </div>
      </section>
    )}

    <!-- === 4. SDG 分类板块 (示例 2) === -->
    <!-- 你可以复制上面的板块来创建所有 SDG 分类 -->
    {sdg2Posts.length > 0 && (
      <section class="category-showcase">
        <h2 class="section-heading">
          <a href="/sdg/2">{getSdgTitle('2')}</a>
        </h2>
        <div class="category-showcase__grid">
          {sdg2Posts.map(post => (
            <article class="content-card content-card--small">
              <a href={`/post/${post.slug.current}`} class="content-card__link">
                {post.coverImage ? (
                  <div class="content-card__image-container">
                    <img
                      class="content-card__image"
                      src={urlFor(post.coverImage).width(400).height(300).auto('format').url()}
                      alt={`[${post.title} 的封面图片]`}
                      loading="lazy"
                    />
                  </div>
                ) : (
                  <div class="content-card__image-placeholder--small"></div>
                )}
                <div class="content-card__content">
                  <h3 class="content-card__title">{post.title}</h3>
                  <span class="content-card__meta">{formatDate(post.publishDate)}</span>
                </div>
              </a>
            </article>
          ))}
        </div>
      </section>
    )}
    
    <!-- === 5. 你原来的 SDG 网格 (侧边栏) === -->
    <!-- 我们仍然可以保留这个，也许放在页脚上方或侧边栏 -->
    <!-- 为了保持主信息流的简洁，我暂时先注释掉它 -->
    <!--
    <section id="sdgs" class="sdg-sidebar">
      <h2 class="section-heading">聚焦所有 SDG 目标</h2>
      <div id="sdg-grid" class="sdg-grid">
      </div>
    </section>
    -->

  </div>
</MainLayout>

<!-- 
  === 样式 ===
  这些是 index.astro 页面专属的样式。
  全局的 :root, .dark, body 样式已移至 MainLayout.astro。
-->
<style>
  .page-container {
    width: 100%;
    max-width: 1300px;
    margin: 0 auto;
    padding: 1rem;
  }

  @media (min-width: 768px) {
    .page-container {
      padding: 2rem;
    }
  }

  /* --- 标题 --- */
  .section-heading {
    font-family: var(--font-heading);
    font-weight: 900;
    font-size: 2.25rem;
    line-height: 1.1;
    color: var(--color-text);
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    margin-top: 2.5rem;
  }
  .section-heading a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s;
  }
  .section-heading a:hover {
    color: var(--color-accent);
  }

  /* --- 1. 头条文章 (Hero) --- */
  .hero-article-wrapper {
    margin-bottom: 2.5rem;
  }
  
  .hero-article {
    display: block;
    position: relative;
    text-decoration: none;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #333;
  }

  .hero-article__image {
    display: block;
    width: 100%;
    height: 60vh;
    max-height: 700px;
    object-fit: cover;
    transition: transform 0.4s ease-out;
  }
  
  .hero-article:hover .hero-article__image {
    transform: scale(1.03);
  }

  .hero-article__gradient {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 75%;
    background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0) 100%);
  }
  
  .hero-article__content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
    color: #ffffff;
  }

  @media (min-width: 768px) {
    .hero-article__content {
      padding: 2.5rem;
    }
  }

  .hero-article__heading {
    font-family: var(--font-heading);
    font-weight: 900;
    font-size: 1.75rem;
    line-height: 1.2;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  .hero-article__byline {
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.75rem;
    opacity: 0.8;
  }

  @media (min-width: 768px) {
    .hero-article__heading {
      font-size: 3rem;
      max-width: 80%;
    }
  }

  /* --- 2. 最新动态 (Top Stories) --- */
  .top-stories__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .top-stories__grid {
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
    }
  }

  .top-stories__left {
    /* 包含大卡片 */
  }

  .top-stories__right {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }
  
  @media (min-width: 640px) and (max-width: 1023px) {
    .top-stories__grid {
       grid-template-columns: 1fr 1fr;
    }
    .top-stories__left {
      /* 在平板上，让大卡片跨越两栏 */
      grid-column: 1 / -1;
    }
    .top-stories__right {
      grid-column: 1 / -1;
      grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 个小卡片 */
    }
  }
  
  @media (max-width: 639px) {
    .top-stories__right {
       grid-template-columns: 1fr; /* 在手机上垂直堆叠 */
    }
  }

  /* --- 3. SDG 分类板块 --- */
  .category-showcase__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .category-showcase__grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (min-width: 1024px) {
    .category-showcase__grid {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }
  }
  
  /* --- 通用文章卡片 (Content Card) --- */
  .content-card {
    border-top: 1px solid var(--color-border);
    padding-top: 1rem;
  }
  
  .top-stories__left .content-card {
     border-top: none; /* 大卡片不需要顶部边框 */
     padding-top: 0;
  }
  
  .content-card__link {
    display: block;
    text-decoration: none;
    color: var(--color-text);
  }

  .content-card__image-container {
    width: 100%;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
  }
  
  .content-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease-out;
  }

  .content-card__link:hover .content-card__image {
    transform: scale(1.05);
  }
  
  .content-card__image-placeholder,
  .content-card__image-placeholder--small {
    width: 100%;
    aspect-ratio: 16 / 10;
    background: var(--color-border);
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }
  
  .content-card--small .content-card__image-container,
  .content-card--small .content-card__image-placeholder--small {
     aspect-ratio: 4 / 3;
  }

  .content-card__title {
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1.25rem;
    line-height: 1.3;
    transition: color 0.2s;
  }
  
  .content-card__link:hover .content-card__title {
    color: var(--color-accent);
  }

  .content-card--large .content-card__title {
    font-size: 1.75rem;
  }
  
  .content-card--small .content-card__title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .content-card__excerpt {
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--color-text-dim);
    margin-top: 0.5rem;
    line-height: 1.6;
  }
  
  .content-card__meta {
    font-family: var(--font-body);
    font-size: 0.875rem;
    color: var(--color-text-dim);
    margin-top: 0.75rem;
  }
</style>

